---
# This playbook installs the ECP Primary Controller
- fail:
    msg: "Error: In order to install ECP, you must specify the host to use as well as the disk configuration, installation parameters and controller configuration information "
  when: 
    (platform.controller.config is undefined) or
    (platform.controller.host is undefined) or
    (platform.controller.disks is undefined) or
    (platform.install is undefined)  

- debug:
    msg: 
    - "*** Installing ECP Controller ***"
    - "Controller Host: {{ platform.controller.host }}"

- name: Obtain session token
  uri:
    url: "{{ platform.rest_protocol }}://{{ platform.controller.host }}:8080/api/v1/login"
    return_content: yes
    method: POST
    validate_certs: "{{ platform.validate_certs }}"
    body_format: json
    body: { "name": "{{ ecp_credentials.site_admin_id }}", "password": "{{ ecp_credentials.site_admin_password }}" }
    status_code: 201
  register: session_res

- name: Prepare input file for epicctl.
  template:
    src: install_platform_controller.j2
    dest: "/tmp/{{ platform.name }}_install_platform_controller.yml"
    mode: 0777

- debug:
    msg: 
    - "*** Installing ECP Control Plane - Controller ***"
    - "Input file content: "
    - "{{ lookup('template', 'install_platform_controller.j2') }}"

- name: Run epicctl command to output its version
  command: "epicctl -v"
  register: res
  failed_when: res.rc != 0

- name: Run epicctl command to install ECP controller 
  command: "epicctl op -f /tmp/{{ platform.name }}_install_platform_controller.yml -n {{ platform.name }}"
  register: res
  failed_when: res.rc != 0

- debug:
    msg: "{{ res.stdout }}"
