---
- name: Prepare input file for epicctl.
  template:
    src: install_platform_controller.j2
    dest: "/tmp/{{ platform.name }}_platform.yml"
    mode: 0777

- debug:
    msg: 
    - "*** Installing ECP Control Plane ***"
    - "Input file content: "
    - "{{ lookup('template', 'install_platform_controller.j2') }}"

- name: Run epicctl command to output its version
  command: "epicctl -v"
  register: res
  failed_when: res.rc != 0

- name: Run epicctl command to install controller, gateways and two EPIC workers (for shadow and arbiter) if HA is configured
  command: "epicctl op -f /tmp/{{ platform.name }}_platform.yml -n {{ platform.name }} --defaultpassword {{ ecp_credenitals.site_admin_password }}"
  register: res
  failed_when: res.rc != 0

# Set hcp_host_id variable values in Ansible inventory

- debug:
    msg: "{{ res.stdout }}"
