---
- debug: 
    msg: "Worker Node IP: {{ hostvars[item].ansible_host }} Host ID: {{ hostvars[item].hcp_host_id }} Status: {{ hostvars[item].status }} Ready: {{ hostvars[item].is_ready }}"
  with_items: "{{ groups['k8s_workers'] }}" 

- name: Create inputfile to create K8s Cluster.
  template:
    src: create_k8s_cluster.j2
    dest: "/tmp/{{ common.name }}_create_k8s_cluster.json"
    mode: 0777
 
#- name: Create K8s Cluster
#  uri:
#    url: http://{{ groups.primary_controller[0] }}:8080/api/v2/k8scluster
#    return_content: yes
#    headers:
#      X-BDS-SESSION: "{{ session_res.location  | urlsplit('path') }}" 
#      accept: "*/*"
#      Content-Type: "application/json"
#    method: POST
#    body_format: json
#    body: "{{ lookup('file','/tmp/CICL_create_k8s_cluster.json') }}"
#    status_code: 201
#  register: cluster_res

#  - name: Poll the status of cluster creation by making get call to /api/v2/k8scluster/k8scluster_id
#    command: epicctl api get -u {{ jsonResp }} -n "OnPremSetup" -p {{ common.platform }} -o /tmp/get-response.json
#    vars:
#      getResp: "{{ (lookup('file', '/tmp/get-response.json') | from_json)['status'] }}"
#    register : res
#    failed_when: res.rc != 0
#    changed_when: false
#    retries: 30
#    delay: 60
#    until:  '"ready" == getResp'

#  - debug:
#      msg: "polling task finished"

- name: Log out of session
  uri:
    url: "{{ ecp_session.location }}"
    return_content: yes
    headers:
      X-BDS-SESSION: "{{ ecp_session.location  | urlsplit('path') }}"  
    method: DELETE
    status_code: 204
  register: delsession_res

- debug:
#    msg: "Session: {{ session_res.location  | urlsplit('path') }} -- Create K8s Cluster Result: {{ cluster_res.status }}"
    msg: "Session: {{ delsession_res.location  | urlsplit('path') }} -- Create K8s Cluster finished."

